# SSE 响应解析问题调试指南

## 当前状态

已改进 SSE（Server-Sent Events）响应解析逻辑，添加了详细的调试日志。

## 问题表现

- ✅ 成功连接到 Coze AI 服务
- ✅ 接收到 SSE 格式的响应（content-type: text/event-stream）
- ❌ 未能正确提取 AI 回复内容
- ❌ 显示原始事件数据而不是实际的分析结果

## 调试步骤

### 1. 查看日志

运行应用后，查看控制台输出，重点关注以下日志：

```
🔍 SSE 原始响应长度: XXXX
🔍 事件 #1, type: message_start
🔍 事件 #2, type: answer
🔍 找到答案片段，长度: XXX
🔍 SSE 解析完成，共 X 个事件，提取内容长度: XXX
```

### 2. 关键信息

从日志中确认：
- **事件总数**：应该有多个事件（通常 2-10 个）
- **事件类型**：查看都有哪些 type（message_start, answer, message_end 等）
- **答案片段**：是否找到了任何答案片段
- **提取内容长度**：最终提取了多少字符

### 3. 常见问题

#### 问题 1：提取内容长度为 0

**可能原因：**
- AI 答案在不同的字段位置
- 需要等待异步响应

**解决方案：**
请提供完整的日志输出，特别是：
- 所有事件的 type
- 原始 SSE 响应的前1000个字符

#### 问题 2：显示原始事件数据

**可能原因：**
- 解析逻辑未能找到答案字段
- 答案确实为空，Coze AI 未生成内容

**当前尝试的字段位置：**
1. `type == 'answer'` 时的 `content.answer`
2. `content.answer`
3. `content.text`
4. `content.message`
5. 顶级 `answer`
6. 顶级 `text`
7. 顶级 `message`

### 4. 如何提供日志

运行应用并触发 AI 分析，然后：

```bash
# 方法1：从控制台复制日志
# 在终端中找到 flutter run 的输出

# 方法2：从日志文件读取
# 日志文件位置：应用文档目录/logs/app_log_YYYYMMDD.txt
```

请提供：
1. 从 "SSE 原始响应长度" 到 "SSE 解析完成" 的所有日志
2. 所有事件的 type 值
3. 是否有 "找到答案片段" 的日志

## 可能的解决方案

### 方案 A：Coze API 使用不同的响应格式

如果答案不在当前检查的字段中，需要：
1. 查看原始响应的完整结构
2. 找到实际包含答案的字段
3. 更新 `_tryExtractAnswer()` 方法

### 方案 B：需要轮询或 WebSocket

某些 AI 服务使用异步模式：
1. 初始请求只返回任务 ID
2. 需要轮询或 WebSocket 获取结果
3. 可能需要修改 API 调用方式

### 方案 C：使用同步 API

如果流式 API 太复杂，可以尝试：
1. 使用非流式的 API endpoint（如果有）
2. 设置 `stream: false` 参数
3. 等待完整响应后一次性返回

## 下一步

1. **测试并提供日志**：运行应用，点击 AI 分析，复制控制台日志
2. **查看原始响应**：如果可能，提供原始 SSE 响应的前 1000 字符
3. **确认 Coze 配置**：确保智能体正确配置，测试简单问题是否有响应

## 联系调试

提供以下信息将帮助快速定位问题：
- Flutter 控制台的完整日志（从发起请求到显示结果）
- Coze 智能体的配置（如果可以的话截图）
- 是否在 Coze 平台的测试界面能正常对话
