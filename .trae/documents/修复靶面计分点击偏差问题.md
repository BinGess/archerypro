# 靶面计分点击位置与分数偏差修复计划

根据您的反馈，目前在靶面模式下点击录入成绩时，存在点击位置与实际判定分数不符的问题（例如点击 9 环却被记录为其他分数）。经过代码分析，问题主要出在 `_handleTargetTap` 方法中的半径计算逻辑与 `TargetFacePainter` 的绘制逻辑不一致。

## 问题根源分析

1.  **判定逻辑偏差**：
    *   在 `_handleTargetTap` 中，您使用了 `targetFaceSize == 40` (6环靶面) 和 `else` (10环靶面) 两种判定逻辑。
    *   **6环靶面 (40cm)**：逻辑假设半径分布为 0.33(10-9环), 0.67(8-7环), 1.0(6环及以外)。
    *   **10环靶面**：逻辑假设每环宽度均匀，均为 0.1 (10%), 即 10环(0-0.1), 9环(0.1-0.2) ... 1环(0.9-1.0)。
2.  **绘制逻辑偏差**：
    *   `TargetFacePainter` 中对于 10 环靶面绘制了 5 个大色块，每个色块包含 2 个环值。例如黄色区域半径是 `radius * 0.2`，包含了 10 环和 9 环。
    *   这意味着绘制逻辑中，10 环和 9 环各占半径的 0.1，这与判定逻辑是**吻合**的。
3.  **可能的错误点**：
    *   **点击区域大小与绘制大小不匹配**：`ScoringScreen` 中 `SizedBox` 大小为 300x300，中心点 150，`drawableRadius` 设为 140。
    *   **判定阈值错误**：目前的逻辑是：
        *   `distance <= 0.1` -> 10分
        *   `distance <= 0.2` -> 9分
        *   ...
        *   这在数学上是正确的（假设每环等宽）。但是，**10环实际上是靶心**。
        *   在标准靶面中，**中心点是 0**。距离中心越远，分数越低。
        *   **9环的外径**是 2 个单位，**10环的外径**是 1 个单位。
        *   代码中的 `distance <= 0.1` 意味着只要在 10% 半径内就是 10 分。
        *   **关键问题**：用户反馈“点击上9环，记录结果偏差”。可能是因为 9 环的判定范围 `0.1 < d <= 0.2` 在视觉上可能与绘制的分割线有微小偏差，或者 `drawableRadius` (140) 与 `CustomPaint` 的绘制半径 (`size.width / 2` = 150) 不一致。

    *   **严重尺寸不匹配**：
        *   `CustomPaint` 的 size 是 300x300，绘制半径是 150。
        *   点击处理逻辑中，`drawableRadius` 硬编码为 **140**。
        *   `140 / 150 = 0.933`。这意味着点击判定的“10环边缘”实际上比绘制的“10环边缘”要**小**。
        *   **后果**：当用户点击绘制的 9 环内侧（靠近 10 环）时，由于判定半径更小，系统可能认为距离已经超过了 0.2（相对于 140），从而误判为 8 环；或者点击 10 环边缘时被判为 9 环。

## 修复方案

### 1. 统一半径标准
将 `_handleTargetTap` 中的 `drawableRadius` 修改为与 `TargetFacePainter` 一致的 **150.0** (即 `targetSize / 2`)。

### 2. 微调判定阈值（可选）
如果仍然存在边缘判定困难，可以引入微小的容差，或者在 UI 上明确显示点击落点。目前的落点标记逻辑也使用了 140 作为半径乘数：
`_arrowMarker(150.0 + position.dy * 140 - 6, ...)`
这会导致标记点显示的位置比用户实际点击的位置更靠内，产生视觉偏差。

**修正步骤**：

1.  修改 `_handleTargetTap`：将 `drawableRadius` 从 140 改为 **150**。
2.  修改 `_buildTargetPanel` 中的 `_arrowMarker` 位置计算：将乘数从 140 改为 **150**，确保标记点准确落在点击位置。
3.  (进阶) 检查 40cm 靶面的判定逻辑是否符合标准室内靶面规则（通常 40cm 靶面只有 10-6 环，中心 10 环大小与标准一致，但裁剪了外圈）。

## 实施计划

1.  **修正 ScoringScreen.dart**：
    *   将 `_handleTargetTap` 中的 `drawableRadius` 修正为 `150.0`。
    *   将 `_buildTargetPanel` 中渲染 `_arrowMarker` 的位置计算乘数修正为 `150.0`。

这应该能立即解决“点击位置与记录结果不符”以及“回显位置偏差”的问题。

