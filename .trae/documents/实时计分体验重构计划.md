# 实时计分体验优化方案

根据你的需求，我们将对实时计分页面进行重大重构，实现类似填表式的计分体验，并优化底部操作栏布局。

## 1. 状态管理重构 (ScoringProvider)
**目标**：支持任意位置的成绩修改，以及基于焦点的输入逻辑。
*   **新增状态字段**：
    *   `focusedEndIndex`: 当前选中的组索引（0-based）。
    *   `focusedArrowIndex`: 当前选中的箭索引（0-based）。
*   **修改 `addArrow(int score)` 逻辑**：
    *   不再是简单的 `addArrowToEnd`，而是根据 `focusedEndIndex` 和 `focusedArrowIndex` 更新对应位置的箭。
    *   如果当前位置已有成绩，则**覆盖**。
    *   如果当前位置是空的，则**填充**。
    *   **自动跳转逻辑**：输入后，焦点自动+1。
        *   组内跳转：`focusedArrowIndex++`。
        *   跨组跳转：如果当前组已满（且不是最后一组），`focusedEndIndex++`, `focusedArrowIndex = 0`。
        *   自动创建：如果跳转到的组尚未创建（例如刚填完第1组，第2组还没生成），则自动创建该组。
*   **移除自动保存**：`addArrow` 完成后不再检查 `isSessionComplete` 并自动保存，仅停留在最后。

## 2. 界面布局重构 (ScoringScreen)
**目标**：实现列表+悬浮底部的布局结构。
*   **整体结构**：
    *   `Scaffold` -> `Column`
    *   `Expanded` -> `ListView` (所有组的列表)。
    *   `Container` -> `BottomPanel` (底部悬浮区域)。
*   **列表区域 (`_buildSessionList`)**：
    *   不再区分“当前组”和“历史组”，而是渲染一个完整的列表。
    *   **动态渲染逻辑**：
        *   渲染 `currentSession.ends` 中的所有组。
        *   如果在最后，且 `ends.length < maxEnds`，渲染一个“待开始”的占位卡片（灰色不可点）。
        *   **或者更简单的策略**：在 `startNewSession` 时就预先生成所有 `End`（状态为未开始），这样列表渲染逻辑更统一，只需根据状态显示颜色。考虑到数据模型兼容性，我们采用**动态渲染 + 占位符**的方式。
    *   **输入框高亮**：
        *   自定义 `ScoreInputBox` 组件，接收 `isSelected` 参数。
        *   当 `endIndex == focusedEndIndex` && `arrowIndex == focusedArrowIndex` 时，显示绿色边框。
    *   **点击交互**：点击任意输入框，调用 `ref.read(...).setFocus(endIndex, arrowIndex)`。
    *   **【再来一组】按钮**：作为 `ListView` 的最后一项（Footer）显示，仅在最后一组下方出现。

*   **底部面板 (`_buildBottomPanel`)**：
    *   **键盘模式 (`!isTargetView`)**：显示数字键盘 + 右侧功能键（移除/保存）。
    *   **靶面模式 (`isTargetView`)**：显示大号靶面 + 底部操作栏（移除成绩/完成成绩）。
    *   **注意**：为了保证靶面模式下上方列表依然可见，靶面区域高度需要适中（例如 300-400dp），或者允许列表区域被压缩但依然可滚动。

## 3. 具体交互细节
*   **状态指示**：
    *   正在进行的组：标题高亮，输入框可交互。
    *   已完成的组：标题正常，输入框可交互（点击修改）。
    *   未开始的组：标题灰色，输入框禁用或显示为占位符。
*   **保存流程**：
    *   用户点击底部的【保存】或【完成成绩】按钮。
    *   触发 `saveSession` -> 跳转首页。

***

**执行步骤**：
1.  **修改 `ScoringState`**：添加 `focusedEndIndex`, `focusedArrowIndex` 及相关 `copyWith`。
2.  **更新 `ScoringNotifier`**：实现 `setFocus`, 重写 `addArrow` 以支持焦点更新和自动跳转。
3.  **重构 `ScoringScreen`**：
    *   拆分 Body 为 `Column(List, BottomPanel)`。
    *   实现 `_buildEndList` 渲染所有组。
    *   实现 `_buildKeypadPanel` 和 `_buildTargetPanel`。
4.  **调试与验证**：测试焦点跳转、修改历史成绩、再来一组功能。
